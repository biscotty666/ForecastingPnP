---
title: "Ch 2.2: Time Plots"
output:
  github_document:
    toc: true
  html_document:
    toc: true
    df_print: paged
---

```{r}
library(fpp3)
library(tsibble)
```

# `autoplot()`

```{r}
ansett
```

Let's look at the weekly economy passenger load on Ansett Airlines between their two largest cities.

```{r}
melsyd_economy <- ansett |>
  filter(Airports == "MEL-SYD", Class == "Economy") |>
  mutate(Passengers = Passengers/1000)
autoplot(melsyd_economy, Passengers) +
  labs(title = "Ansett airlines economy class",
       subtitle = "Melbourne-Sydney",
       y = "Passengers (,000)")
```

Note:

* The period in 1989 when no passengers were carried - d/t an industrial dispute
* Reduced load in 1992 - d/t a trial program which replaced economy seats by business class seats
* Large increase in passenger load in second half 1991 - unexplained
* Large dips in load around the start of each year - holiday effects
* Long-term fluctuations with an increase in level in 1987, decrease in 1989, increase through 1990 and 1991

A model needs to take all these features into account.

Looking at our simpler time series from 2.1:

```{r}
PBS |>
  filter(ATC2 == "A10") |>
  select(Month, Concession, Type, Cost) |>
  summarise(TotalC = sum(Cost)) |>
  mutate(Cost = TotalC/1e6) -> a10
autoplot(a10, Cost) +
  labs(y = "$ (millions)",
       title = "Australian antidiabetic drug sales")
```

This shows a clear and increasing trend.

# 2.4 Seasonal plots

```{r}
a10 |>
  gg_season(Cost, labels = "both") +
  labs(y = "$ (millions)",
       title = "Seasonal plot: Antidiabetic drug sales")
```

Useful for identifying Years with with unusual patterns. In this case we see 2008 dipping lower than usual in March 2008. The low figure in June could be the result of incomplete data.

## Multiple seasonal periods

`period` can be used for data with multiple seasonal patterns by specifying daily, weekly or yearly patterns

```{r}
vic_elec
```

```{r}
vic_elec |> gg_season(Demand, period = "day") +
  theme(legend.position = "none") +
  labs(y = "Mwh", title = "Electricity demain in Victoria")
```
```{r}
vic_elec |> gg_season(Demand, period = "week") +
  theme(legend.position = "none") +
  labs(y = "Mwh", title = "Electricity demain in Victoria")
```
```{r}
vic_elec |> gg_season(Demand, period = "year") +
  theme(legend.position = "none") +
  labs(y = "Mwh", title = "Electricity demain in Victoria")
```

# 2.5 Seasonal subseries plots

```{r}
a10 |>
  gg_subseries(Cost) +
  labs(
    y = "$ (million)",
    title = "Australian antidibetic drug sales"
  )
```

This plot collects each season into seperate mini time plots. The blue line indicates the mean. This plot is useful to clearly view the underlying seasonal pattern and shows the changes in seasonality over time. In this case it is not very interesting.

## Example: Australian holiday tourism

```{r}
tourism
```

Lets consider the total visitor nights on holiday for each quarter.

```{r}
holidays <- tourism |>
  filter(Purpose == "Holiday") |>
  group_by(State) |>
  summarise(Trips = sum(Trips))
holidays
```
```{r}
autoplot(holidays, Trips) +
  labs(y = "Overnight trips",
       title = "Australian domestic holidays")
```

The plot shows strong seasonality for most states but the peaks do not necessarily coincide.To see the timing of those seasonal peaks use a `gg_season()` plot.

```{r}
gg_season(holidays, Trips) +
  labs(y = "Overnight trips ('000)",
       title = "Austrlian domestic holidays")
```

And a `gg_subseries()` plot

```{r}
gg_subseries(holidays, Trips) +
  labs(y = "Overnight trips ('000)",
       title = "Austrlian domestic holidays")
```

Here we see the increase in Western Australia in recent years. Also Victoria's strong increas in Q1 and Q4 but not in the other quarters.

## 2.6 Scatterplots

The above plots are used to explore individual time series. Scatterplots can explore the relationship between two time series.

The following shows half-hourly electricity demand and temperature for 2014 in Victoria Australia.

```{r}
vic_elec |>
  filter(year(Time) == 2014) |>
  autoplot(Demand) +
  labs(y = "GW",
       title = "Half-hourly electricity demand: Victoria")
```

```{r}
vic_elec |>
  filter(year(Time) == 2014) |>
  autoplot(Temperature) +
  labs(
    y = "Degrees Celsius",
    title = "Half-hourly temperatures: Melbourne, Australia"
  )
```

```{r}
vic_elec |>
  filter(year(Time) == 2014) |>
  ggplot(aes(x = Temperature, y = Demand)) +
  geom_point() +
  labs(x = "Temperature (degrees Celsius)",
       y = "Electricity demand")
```

This shows a high demand when temperatures are high as well as when they are low.

## Correlation

The **correlation coefficients** measure the strength of the linear relationship between two variables.

$$
r = \frac{\sum (x_{t} - \bar{x})(y_{t}-\bar{y})}{\sqrt{\sum(x_{t}-\bar{x})^2}\sqrt{\sum(y_{t}-\bar{y})^2}}
$$

for $r$ between -1 and 1.

<img src="https://otexts.com/fpp3/fpp_files/figure-html/corr-1.png" />

The correlation coefficient only measures the strenght of the **linear** relationship.

<img src="https://otexts.com/fpp3/fpp_files/figure-html/anscombe-1.png" />

These plots all have correlation coefficients of 0.82 but have very different relationships. Plots are important. Do not rely on correlation values alone.

## Scatterplot matrices

A useful starting point is to plot each variable agains each other variable.

```{r}
visitors <- tourism |>
  group_by(State) |>
  summarise(Trips = sum(Trips))
visitors |>
  ggplot(aes(x = Quarter, y = Trips)) +
  geom_line() +
  facet_grid(vars(State), scales = "free_y") +
  labs(title = "Australian domestic tourism",
       y= "Overnight trips ('000)")
```

```{r}
visitors |>
  pivot_wider(values_from=Trips, names_from=State) |>
  GGally::ggpairs(columns = 2:9)
```













